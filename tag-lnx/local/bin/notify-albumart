#!/usr/bin/env bash

set -e
set -u
set -o pipefail

declare -r covers="$XDG_DATA_HOME/albumart"
declare -r track=$2
declare -r artist_album=$3
declare -r artist=${artist_album/ - */}
declare -r album=${artist_album/* - /}
# shellcheck disable=SC2155
declare -r cover_name=$(printf %s "$artist$album" | md5sum | cut -d' ' -f1)
declare -r cover_path="$covers/$cover_name"

function urlencode {
  python -c "import urllib.parse, sys; print(urllib.parse.quote_plus(sys.argv[1] if len(sys.argv) > 1 else sys.stdin.read()[0:-1]))" "$1"
}

if [[ ! -f "$cover_path.png" ]]; then
  artist_url=$(urlencode "$artist")
  album_url=$(urlencode "$album")
  query="q=artist:$artist_url%20album:$album_url&type=album"
  url=$(curl --silent --fail "https://api.spotify.com/v1/search?$query" | jq -re '.albums.items[0].images[-1].url')
  curl --silent --fail -o "$cover_path" "$url"
  convert "$cover_path" -resize "36x36" "$cover_path.png"
  rm -f "$cover_path"
fi

notify-send \
  -u low \
  -i "$cover_path.png" \
  "$track" \
  "$artist\n$album"
