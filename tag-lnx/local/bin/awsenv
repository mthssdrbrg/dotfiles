#!/usr/bin/env bash

set -eu -o pipefail

declare profile="default"
declare access_key secret_key region=""

while (( $# > 0 )); do
  case "$1" in
    -p|--profile) profile="$2" ; shift ;;
    -p=|--profile=) profile="${1#*=}" ;;
    -r|--region) region="$2" ; shift ;;
    -r=|--region=) region="${1#*=}" ;;
    --debug) set -x ;;
    *) break ;;
  esac
  shift
done

access_key="$(aws configure get "$profile.aws_access_key_id")"
secret_key="$(aws configure get "$profile.aws_secret_access_key")"
if [[ -z "$region" ]]; then
  region="$(aws configure get "$profile.region" || :)"
fi

if [[ -n "$access_key" && -n "$secret_key" ]]; then
  export AWS_ACCESS_KEY_ID="$access_key" 
  export AWS_SECRET_ACCESS_KEY="$secret_key"
  if [[ -n "$region" ]]; then
    export AWS_REGION="$region"
  fi
  exec "$@"
else
  echo "missing either access key id or secret access key from aws-cli config" >&2
  exit 1
fi
