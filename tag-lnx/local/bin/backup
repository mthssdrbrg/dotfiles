#!/usr/bin/env bash

set -E
set -x

trap 'notify-error $now' ERR

declare -r backup_dir="$HOME/backup"
declare -r repo="$backup_dir/home"
declare -r passphrase_file="$HOME/.secrets/backup-home"
declare passphrase now

function notify-error() {
  local msg=$1
  notify-send --urgency critical --app-name "backup" "error during backup of $msg"
}

function notify-info() {
  local msg=$1
  notify-send --urgency low --app-name "backup" "$msg"
}

if [[ -f "$passphrase_file" ]]; then
  passphrase="$(cat "$passphrase_file")"
else
  passphrase=$(pass show backup/home)
fi
now="$(date +%Y%m%d%H%M%S)"

export BORG_PASSPHRASE="$passphrase"

notify-info "starting backup $now"

(
  flock --exclusive --nonblock 9 || exit 1

  borg create \
    --info \
    --stats \
    --numeric-owner \
    --compression zlib \
    --exclude-if-present .no-backup \
    "$repo::$now"\
    "$HOME"

  borg prune \
    --info \
    --list \
    --keep-hourly 24 \
    --keep-daily 7 \
    --keep-weekly 4 \
    --keep-monthly 6 \
    "$repo"

  notify-info "uploading backup $now"

  rclone sync "$backup_dir" amzn:backup/

  notify-info "finished backup $now"
) 9> "$backup_dir/.home-lock"
