#!/bin/bash

# Redirect output to stderr
exec 1>&2

function log_done {
  echo -e "[ \033[0;34mpost-up\033[0m:\033[0;32m$1\033[0m ] up-to-date"
}

function log_do {
  echo -e "[ \033[0;34mpost-up\033[0m:$1 ] $2"
}

log_do "init" "starting"

if [ -z "$RCM_SKIP_BREW" ]; then
  if ! command -v brew &> /dev/null; then
    log_do "homebrew" "installing"
    ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  else
    log_done "homebrew"
  fi

  if command -v brew &> /dev/null; then
    log_do "homebrew" "installing packages from Brewfile and Caskfile"
    brew update
    brew tap "homebrew/bundle"
    brew bundle check --file="$HOME/.dotfiles/homebrew/Brewfile"
  fi
fi

if [ ! -e "$HOME/.vim/bundle/Vundle.vim" ]; then
  log_do "vim" "installing Vundle and plugins"
  git clone https://github.com/gmarik/Vundle.vim.git $HOME/.vim/bundle/Vundle.vim
  vim -u $HOME/.vimrc.bundles +PluginInstall +qa
else
  log_done "vim"
fi

if [ ! -e "$HOME/.zprezto" ]; then
  log_do "zprezto" "installing"
  git clone --recursive https://github.com/mthssdrbrg/prezto.git "${ZDOTDIR:-$HOME}/.zprezto"
else
  log_done "zprezto"
fi

if [ ! -e $HOME/Library/Application\ Support/Karabiner/private.xml ]; then
  log_do "karabiner" "linking"
  ln -s $HOME/.dotfiles/karabiner/private.xml $HOME/Library/Application\ Support/Karabiner/private.xml
else
  log_done "karabiner"
fi

if [ -e "$HOME/Dropbox/dotfiles/bin" ]; then
  for path in $HOME/Dropbox/dotfiles/bin/*; do
    dot_bin_path="$HOME/.bin/$(basename "$path")"
    if [ ! -e "$dot_bin_path" ]; then
      log_do "dropbox-bin" "$path -> $dot_bin_path"
      ln -s "$path" "$dot_bin_path"
    fi
  done
fi
